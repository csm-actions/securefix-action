# v0.4.1

[Issues](https://github.com/csm-actions/securefix-action/issues?q=is%3Aissue+is%3Aclosed+milestone%3Av0.4.1) | [Pull Requests](https://github.com/csm-actions/securefix-action/pulls?q=is%3Apr+is%3Aclosed+milestone%3Av0.4.1) | https://github.com/csm-actions/securefix-action/compare/v0.3.6...v0.4.1 | [Base revision](https://github.com/csm-actions/securefix-action/tree/e589497d69922a54440ea42d8a1c336795fc26c6)

## :warning: Breaking Changes :warning:

> [!IMPORTANT]
> Actions for server workflows support the client action v0.3.x, which means you can update actions for server workflows before updating client action to v0.4.

### 1. prepare, commit, notify, and js actions were removed. They were unified to csm-actions/securefix-action

Before:

```yaml
- uses: csm-actions/securefix-action/server/prepare@latest
```

After:

```yaml
- uses: csm-actions/securefix-action@latest
  with:
    action: prepare # client, server, validate-config, prepare, commit, notify
```

### 2. `pull_request_team_reviewers` and `project_number` don't work by default anymore.

To assign team reviewers and add pull requests to projects, `allow_members_read` and `allow_organization_projects_write` must be true.

```yaml
- uses: csm-actions/securefix-action@latest
  with:
    action: prepare
    allow_members_read: true
    allow_organization_projects_write: true
```

### 3. Some outputs are removed from prepare action

- pull_request_number: Use the output `pull_request.number`
- workflow_run_id: Use the output `workflow_run.id`
- github_token_for_push: Use the output `github_token`
- root_dir:
- automerge_method: Use the output `create_pull_request.automerge_method`
- project_owner: Use the output `create_pull_request.project.owner`
- project_number: Use the output `create_pull_request.project.number`

## Performance Improvement

This release rewrites composite actions in a single JavaScript Action.
This improves the performance of both client and server drastically.

1. Speeding up Action download time
2. Rewriting shell scripts in Node.js
3. Converting composite actions into a single JavaScript Action to eliminate step-to-step overhead
4. Various smaller performance improvements such as deferring label removal, reducing the number of generated access tokens from two to one, and parallelizing API calls

Among these improvements, the most impactful is the reduction of **Action download time**.
A GitHub Actions job first runs the `Set up job` step, during which it downloads all actions referenced in the job.
The download time scales with the number of actions, and as that number increases, the cost becomes significant.

Originally, Securefix Action consisted of four composite actions, and each composite action depended on additional actions.
As a result, the entire job depended on a considerable number of actions, leading to noticeable download time.

This release dramatically reduces that download time by rewriting all of these actions into a **single JavaScript Action**.
By switching behavior based on the `action` input, the new implementation can still perform the same four types of processing as before.

```yaml
- uses: csm-actions/securefix-action@latest
  with:
    action: prepare # client, prepare, commit, notify
```

- GitHub Actions downloads only single action.

## `issues:write` permission is unnecessary

This release fixes the wrong document.
`pull_request_labels` don't require `issues:write` permission.
But note that this action doesn't create labels.
Labels must exist in advance.

## Features

1. Support `project_id`. project_id can be used instead of `project_number`. If `project_number` is used, the action retrieves the project id by GitHub API. By setting `project_id`, the action doesn't need to call GitHub API to get the project id.
1. Support the new action `server`, which merges actions `prepare`, `commit`, and `notify`

Before:

```yaml
- uses: csm-actions/securefix-action@latest
  id: prepare
  with:
    action: prepare
    app_id: ${{ vars.AUTOFIX_APP_ID }}
    app_private_key: ${{ secrets.AUTOFIX_APP_PRIVATE_KEY }}
    allow_workflow_fix: true
    allow_members_read: true
    allow_organization_projects_write: true
    config_file: config.yaml
    workflow_name: ""
- uses: csm-actions/securefix-action@latest
  with:
    action: commit
    outputs: ${{ toJson(steps.prepare.outputs) }}
- uses: csm-actions/securefix-action@latest
  if: failure()
  with:
    action: notify
    outputs: ${{ toJson(steps.prepare.outputs) }}
      - uses: csm-actions/securefix-action@pr/339
        with:
          action: server
          app_id: ${{ vars.AUTOFIX_APP_ID }}
          app_private_key: ${{ secrets.AUTOFIX_APP_PRIVATE_KEY }}
          allow_workflow_fix: true
          allow_members_read: true
          allow_organization_projects_write: true
          config_file: config.yaml
          workflow_name: ""
```

After:

```yaml
- uses: csm-actions/securefix-action@latest
  with:
    action: server
    app_id: ${{ vars.AUTOFIX_APP_ID }}
    app_private_key: ${{ secrets.AUTOFIX_APP_PRIVATE_KEY }}
    allow_workflow_fix: true
    allow_members_read: true
    allow_organization_projects_write: true
    config_file: config.yaml
    workflow_name: ""
```

3. Improve pull request comments

The error message is added.

<img width="966" height="369" alt="image" src="https://github.com/user-attachments/assets/ea9e1a08-281d-4f82-9b8d-f9e66c21ae57" />

You can post the error of commit action by passing the error to notify action via `commit_error` input.

```yaml
- uses: csm-actions/securefix-action@latest
  id: commit
  with:
    action: commit
    outputs: ${{ toJson(steps.prepare.outputs) }}
- uses: csm-actions/securefix-action@latest
  if: failure()
  with:
    action: notify
    outputs: ${{ toJson(steps.prepare.outputs) }}
    commit_error: ${{steps.commit.outputs.error}}
```

4. Embed github-comment metadata.

```html
<!-- github-comment: {"SHA1":"30a47811124cc53ea812075a8b1b20134264574f","Program":"securefix-action","TemplateKey":"notify"} -->
```

5. Log links to client workflow run, pull request, and posted comment.

<img width="916" height="353" alt="image" src="https://github.com/user-attachments/assets/205376f3-a5fb-4d3f-964b-3a08356f5530" />

6. Skip a pr comment when `Update is not a fast forward`.
